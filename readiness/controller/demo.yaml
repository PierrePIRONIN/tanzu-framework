---
apiVersion: core.tanzu.vmware.com/v1alpha2
kind: Readiness
metadata:
  name: baseline
spec:
  checks:
  - name: com.vmware.tanzu.certificate-management
    type: basic
    category: Security
  - name: com.vmware.tanzu.package-management
    type: basic
    category: Packaging
  - name: com.vmware.tanzu.secret-management
    type: basic
    category: Security
  - name: com.vmware.tanzu.ssd-storage
    type: basic
    category: Storage
---
apiVersion: core.tanzu.vmware.com/v1alpha2
kind: ReadinessProvider
metadata:
  name: cert-manager  
spec:
  checkRefs: 
  - com.vmware.tanzu.certificate-management
  repeatInterval: 30s
  conditions:
  - name: certificate-crd
    resourceExistenceCondition:
      apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition      
      name: certificates.cert-manager.io
---
apiVersion: core.tanzu.vmware.com/v1alpha2
kind: ReadinessProvider
metadata:
  name: cluster-essentials
spec:
  checkRefs: 
  - com.vmware.tanzu.package-management
  - com.vmware.tanzu.secret-management
  repeatInterval: 60s
  conditions:
  - name: package-crd
    resourceExistenceCondition:
      apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition      
      name: packageinstalls.packaging.carvel.dev
  - name: secrettemplates-crd
    resourceExistenceCondition:
      apiVersion: apiextensions.k8s.io/v1
      kind: CustomResourceDefinition      
      name: secrettemplates.secretgen.carvel.dev
---
apiVersion: core.tanzu.vmware.com/v1alpha2
kind: ReadinessProvider
metadata:
  name: azure-ssd
spec:
  checkRefs:   
  - com.vmware.tanzu.ssd-storage
  repeatInterval: 60s
  conditions:
  - name: ssd-storage
    shellScriptCondition:
      script: |
        count=`kubectl get storageclass -o json | jq '[.items | .[] | {provisioner: .provisioner, sku: .parameters.skuName} | select( .sku != null )| select(.provisioner == "disk.csi.azure.com") | select(.sku | contains("SSD"))] | length'`
        echo $count
        if [ $count -gt 0 ]
        then
          exit 0
        else
          exit 1
        fi
---
apiVersion: core.tanzu.vmware.com/v1alpha2
kind: ReadinessProvider
metadata:
  name: aws-ssd
spec:
  checkRefs:   
  - com.vmware.tanzu.ssd-storage
  repeatInterval: 60s
  conditions:
  - name: ssd-storage
    shellScriptCondition:
      script: |
        count=`kubectl get storageclass -o json | jq '[.items | .[] | {type: .parameters.type} | select(.type == "gp2" or .type == "io1")] | length'`
        echo $count
        if [ $count -gt 0 ]
        then
          exit 0
        else
          exit 1
        fi